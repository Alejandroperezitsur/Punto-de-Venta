generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Store {
  id           Int      @id @default(autoincrement())
  name         String
  address      String?
  phone        String?
  zip_code     String?
  rfc          String?
  fiscal_name  String?
  tax_regime   String?
  
  // Internationalization & White-Label
  reseller_id  Int?      @default(1)
  country      String?   @default("MX")
  currency     String?   @default("MXN")
  timezone     String?   @default("America/Mexico_City")

  reseller     Reseller? @relation(fields: [reseller_id], references: [id])
  
  users        UserStore[]
  products     Product[]
  sales        Sale[]
  invoices     Invoice[]
  customers    Customer[]
  categories   Category[]
  settings     StoreSetting[]
  audits       Audit[]
  cashSessions CashSession[]
  licenses     License[]
  
  @@map("stores")
}

model User {
  id                  Int       @id @default(autoincrement())
  username            String    @unique
  password_hash       String
  active              Int       @default(1)
  is_super_admin      Boolean   @default(false)
  created_at          DateTime  @default(now())
  last_login          DateTime?
  
  stores              UserStore[]
  cash_sessions       CashSession[]
  receivable_payments ReceivablePayment[]
  audits              Audit[]

  @@map("users")
}

model UserStore {
  id        Int      @id @default(autoincrement())
  user_id   Int
  store_id  Int
  role      String   // admin, supervisor, cajero
  
  user      User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  store     Store    @relation(fields: [store_id], references: [id], onDelete: Cascade)

  @@unique([user_id, store_id])
  @@map("user_stores")
}

model StoreSetting {
  store_id  Int
  key       String
  value     String

  store     Store    @relation(fields: [store_id], references: [id], onDelete: Cascade)

  @@id([store_id, key])
  @@map("store_settings")
}

// Maps to existing 'settings' for backward compatibility or global settings
// We might migrate data from 'settings' to 'store_settings'
model GlobalSetting {
  key   String @id
  value String

  @@map("settings")
}

model Category {
  id          Int       @id @default(autoincrement())
  store_id    Int       @default(1)
  name        String
  image_url   String?
  parent_id   Int?
  
  store       Store     @relation(fields: [store_id], references: [id], onDelete: Cascade)
  parent      Category? @relation("CategoryHierarchy", fields: [parent_id], references: [id])
  children    Category[] @relation("CategoryHierarchy")
  products    Product[]
  
  @@unique([store_id, name])
  @@map("categories")
}

model Product {
  id          Int       @id @default(autoincrement())
  store_id    Int       @default(1)
  name        String
  sku         String?
  price       Float
  cost        Float?    @default(0)
  stock       Float?    @default(0)
  category_id Int?
  image_url   String?
  active      Int?      @default(1)
  
  // Fiscal info could be per product (e.g. tax rate override)
  tax_rate    Float?    @default(0.16) // Default IVA 16%
  tax_exempt  Boolean   @default(false)

  store       Store     @relation(fields: [store_id], references: [id], onDelete: Cascade)
  category    Category? @relation(fields: [category_id], references: [id])
  movements   InventoryMovement[]
  sale_items  SaleItem[]
  barcodes    ProductBarcode[]

  // SKU constraint: unique per store
  @@unique([store_id, sku])
  @@index([name])
  @@map("products")
}

model ProductBarcode {
  id         Int      @id @default(autoincrement())
  product_id Int
  code       String   @unique
  created_at DateTime @default(now())
  
  product    Product  @relation(fields: [product_id], references: [id], onDelete: Cascade)

  @@map("product_barcodes")
}

model InventoryMovement {
  id         Int      @id @default(autoincrement())
  product_id Int
  change     Float
  reason     String?
  created_at DateTime @default(now())
  
  product    Product  @relation(fields: [product_id], references: [id], onDelete: Cascade)

  @@map("inventory_movements")
}

model Customer {
  id          Int       @id @default(autoincrement())
  store_id    Int       @default(1)
  name        String
  phone       String?
  email       String?
  
  // Fiscal Data
  rfc         String?
  fiscal_name String?
  tax_regime  String?
  zip_code    String?
  use_cfdi    String? // e.g. G03

  store       Store     @relation(fields: [store_id], references: [id], onDelete: Cascade)
  sales       Sale[]
  receivables Receivable[]
  invoices    Invoice[]

  @@map("customers")
}

model Sale {
  id             Int       @id @default(autoincrement())
  store_id       Int       @default(1)
  customer_id    Int?
  subtotal       Float
  tax            Float
  discount       Float
  total          Float
  payment_method String
  created_at     DateTime  @default(now())
  
  store          Store     @relation(fields: [store_id], references: [id], onDelete: Cascade)
  customer       Customer? @relation(fields: [customer_id], references: [id])
  items          SaleItem[]
  payments       Payment[]
  receivables    Receivable[]
  invoices       Invoice[]

  @@index([created_at])
  @@map("sales")
}

model SaleItem {
  id         Int     @id @default(autoincrement())
  sale_id    Int
  product_id Int
  quantity   Float
  unit_price Float
  line_total Float
  
  sale       Sale    @relation(fields: [sale_id], references: [id], onDelete: Cascade)
  product    Product @relation(fields: [product_id], references: [id])

  @@map("sale_items")
}

model Payment {
  id          Int      @id @default(autoincrement())
  sale_id     Int
  method      String
  amount      Float
  user_id     Int?
  created_at  DateTime @default(now())
  
  // External Payment info
  external_id String?
  provider    String? // stripe, mercadopago
  status      String? @default("completed") // pending, completed, failed

  sale       Sale     @relation(fields: [sale_id], references: [id], onDelete: Cascade)

  @@map("payments")
}

model Receivable {
  id          Int       @id @default(autoincrement())
  customer_id Int
  sale_id     Int
  amount_due  Float
  amount_paid Float     @default(0)
  status      String
  created_at  DateTime  @default(now())
  
  customer    Customer  @relation(fields: [customer_id], references: [id], onDelete: Cascade)
  sale        Sale      @relation(fields: [sale_id], references: [id], onDelete: Cascade)
  payments    ReceivablePayment[]

  @@map("receivables")
}

model ReceivablePayment {
  id            Int        @id @default(autoincrement())
  receivable_id Int
  user_id       Int
  amount        Float
  created_at    DateTime   @default(now())
  
  receivable    Receivable @relation(fields: [receivable_id], references: [id], onDelete: Cascade)
  user          User       @relation(fields: [user_id], references: [id])

  @@map("receivable_payments")
}

model CashSession {
  id              Int       @id @default(autoincrement())
  store_id        Int       @default(1)
  user_id         Int
  opened_at       DateTime  @default(now())
  closed_at       DateTime?
  opening_balance Float
  closing_balance Float?
  status          String
  
  store           Store     @relation(fields: [store_id], references: [id], onDelete: Cascade)
  user            User      @relation(fields: [user_id], references: [id], onDelete: Cascade)
  movements       CashMovement[]

  @@map("cash_sessions")
}

model CashMovement {
  id          Int         @id @default(autoincrement())
  session_id  Int
  type        String
  reference   String?
  amount      Float
  created_at  DateTime    @default(now())
  
  session     CashSession @relation(fields: [session_id], references: [id], onDelete: Cascade)

  @@map("cash_movements")
}

model Invoice {
  id          Int      @id @default(autoincrement())
  store_id    Int
  sale_id     Int
  customer_id Int?
  
  uuid        String?  // UUID Fiscal (Folio Fiscal)
  rfc_emisor  String
  rfc_receptor String
  total       Float
  xml_url     String?
  pdf_url     String?
  status      String   @default("draft") // draft, stamped, cancelled
  
  created_at  DateTime @default(now())
  stamped_at  DateTime?

  store       Store    @relation(fields: [store_id], references: [id], onDelete: Cascade)
  sale        Sale     @relation(fields: [sale_id], references: [id], onDelete: Cascade)
  customer    Customer? @relation(fields: [customer_id], references: [id])

  @@map("invoices")
}

model ProductEvent {
  id        Int      @id @default(autoincrement())
  type      String
  user_id   Int?
  store_id  Int?
  data      String?
  created_at DateTime @default(now())

  @@index([type])
  @@index([store_id])
  @@map("product_events")
}

model UserFeedback {
  id        Int      @id @default(autoincrement())
  user_id   Int?
  type      String   // 'bug', 'suggestion', 'other'
  comment   String
  rating    Int?
  url       String?
  created_at DateTime @default(now())

  @@map("user_feedback")
}

model FeatureVote {
  id           Int      @id @default(autoincrement())
  feature_name String   @unique
  description  String?
  votes        Int      @default(0)
  status       String   @default("planned") // planned, in_progress, completed
  created_at   DateTime @default(now())

  @@map("feature_votes")
}

model Audit {
  id         Int      @id @default(autoincrement())
  store_id   Int      @default(1)
  event      String
  user_id    Int?
  ref_type   String?
  ref_id     Int?
  data       String?
  created_at DateTime @default(now())

  store      Store    @relation(fields: [store_id], references: [id], onDelete: Cascade)
  user       User?    @relation(fields: [user_id], references: [id])

  @@map("audits")
}

model License {
  id           Int      @id @default(autoincrement())
  store_id     Int?     @default(1)
  license_key  String   @unique
  license_type String
  machine_id   String?
  activated_at DateTime?
  expires_at   DateTime?
  features     String?
  created_at   DateTime @default(now())

  store        Store?   @relation(fields: [store_id], references: [id])

  @@map("licenses")
}

model Backup {
  id         Int      @id @default(autoincrement())
  filename   String
  size       Int?
  type       String
  created_at DateTime @default(now())

  @@map("backups")
}

model Reseller {
  id           Int      @id @default(autoincrement())
  name         String
  domain       String   @unique
  logo_url     String?
  primary_color String? @default("#4f46e5")
  support_email String?
  created_at   DateTime @default(now())

  stores       Store[]
  
  @@map("resellers")
}

model SupportTicket {
  id           Int      @id @default(autoincrement())
  store_id     Int
  user_id      Int
  subject      String
  message      String
  status       String   @default("open") // open, in_progress, resolved, closed
  priority     String   @default("normal") // low, normal, high, urgent
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt

  store        Store    @relation(fields: [store_id], references: [id], onDelete: Cascade)
  user         User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  messages     TicketMessage[]

  @@map("support_tickets")
}

model TicketMessage {
  id        Int      @id @default(autoincrement())
  ticket_id Int
  user_id   Int?     // Null if system/agent
  message   String
  is_staff  Boolean  @default(false)
  created_at DateTime @default(now())

  ticket    SupportTicket @relation(fields: [ticket_id], references: [id], onDelete: Cascade)
  
  @@map("ticket_messages")
}

model Subscription {
  id             Int       @id @default(autoincrement())
  store_id       Int       @unique
  plan_id        String    // free, pro, enterprise
  status         String    // active, past_due, canceled
  current_period_end DateTime?
  payment_method String?
  
  store          Store     @relation(fields: [store_id], references: [id], onDelete: Cascade)
  
  @@map("subscriptions")
}

model AiInsight {
  id           Int      @id @default(autoincrement())
  store_id     Int
  type         String   // prediction, alert, opportunity
  title        String
  description  String
  data         String?  // JSON context
  priority     String   @default("info") // info, warning, critical
  is_read      Boolean  @default(false)
  created_at   DateTime @default(now())

  store        Store    @relation(fields: [store_id], references: [id], onDelete: Cascade)

  @@map("ai_insights")
}

model AiConfig {
  store_id              Int      @id
  enable_predictions    Boolean  @default(true)
  enable_recommendations Boolean @default(true)
  enable_assistant      Boolean  @default(true)
  low_stock_threshold   Int      @default(5)
  analysis_period_days  Int      @default(30)

  store                 Store    @relation(fields: [store_id], references: [id], onDelete: Cascade)

  @@map("ai_configs")
}
