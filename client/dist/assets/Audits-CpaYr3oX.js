import{r as c,g as U,R as e,B,S as I,a as F}from"./index-DbtmaT95.js";function J({filters:s,onChange:m,events:t}){const[a,o]=c.useState(s);c.useEffect(()=>{o(s)},[s]);const v=()=>m(a);return e.createElement("div",{className:"card",style:{marginBottom:12}},e.createElement("h3",null,"Filtros"),e.createElement("div",{className:"grid-4",style:{gap:8}},e.createElement("div",{className:"field"},e.createElement("span",{className:"label"},"Desde"),e.createElement("input",{type:"date",value:a.startDate||"",onChange:l=>o({...a,startDate:l.target.value})})),e.createElement("div",{className:"field"},e.createElement("span",{className:"label"},"Hasta"),e.createElement("input",{type:"date",value:a.endDate||"",onChange:l=>o({...a,endDate:l.target.value})})),e.createElement("div",{className:"field"},e.createElement("span",{className:"label"},"Usuario"),e.createElement("input",{type:"text",placeholder:"ID",value:a.userId||"",onChange:l=>o({...a,userId:l.target.value})})),e.createElement("div",{className:"field"},e.createElement("span",{className:"label"},"Evento"),e.createElement("select",{value:a.event||"",onChange:l=>o({...a,event:l.target.value})},e.createElement("option",{value:""},"Todos"),t.map(l=>e.createElement("option",{key:l,value:l},l)))),e.createElement("div",{className:"field",style:{gridColumn:"1 / -1"}},e.createElement("span",{className:"label"},"Buscar"),e.createElement("input",{type:"text",placeholder:"Texto libre",value:a.search||"",onChange:l=>o({...a,search:l.target.value})}))),e.createElement("div",{className:"row",style:{justifyContent:"flex-end",marginTop:8}},e.createElement("button",{className:"btn",onClick:v},"Aplicar")))}function L({items:s,onShow:m}){return e.createElement("table",{className:"table"},e.createElement("thead",null,e.createElement("tr",null,e.createElement("th",null,"Fecha/Hora"),e.createElement("th",null,"Usuario"),e.createElement("th",null,"Evento"),e.createElement("th",null,"Referencia"),e.createElement("th",null,"Data"),e.createElement("th",null))),e.createElement("tbody",null,s.map(t=>e.createElement("tr",{key:t.id},e.createElement("td",null,t.created_at),e.createElement("td",null,t.user_id||"-"),e.createElement("td",null,t.event),e.createElement("td",null,[t.ref_type||"-",t.ref_id||"-"].join(" / ")),e.createElement("td",{style:{maxWidth:360,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}},(()=>{try{const a=t.data?JSON.parse(t.data):null;return a?JSON.stringify(a):""}catch{return String(t.data||"")}})()),e.createElement("td",null,e.createElement("button",{className:"btn btn-ghost",onClick:()=>m(t)},"Ver detalles"))))))}function H({item:s,onClose:m}){if(!s)return null;let t="";try{t=JSON.stringify(s.data?JSON.parse(s.data):null,null,2)}catch{t=String(s.data||"")}return e.createElement("div",{className:"modal-overlay"},e.createElement("div",{className:"card modal",style:{maxWidth:680}},e.createElement("h3",null,"Detalles"),e.createElement("div",{className:"muted"},s.event," • ",s.created_at," • Usuario ",s.user_id||"-"),e.createElement("pre",{style:{background:"var(--bg2)",padding:10,borderRadius:6,maxHeight:360,overflow:"auto"}},t),e.createElement("div",{className:"modal-actions"},e.createElement("button",{className:"btn",onClick:m},"Cerrar"))))}function V(){const[s,m]=c.useState([]),[t,a]=c.useState({startDate:"",endDate:"",userId:"",event:"",search:"",limit:20,offset:0}),[o,v]=c.useState([]),[l,D]=c.useState(0),[x,h]=c.useState(null),[k,g]=c.useState(!1);c.useEffect(()=>{(async()=>{try{const n=await U();m(n)}catch{}})()},[]);const A=async()=>{g(!0);try{const n=(()=>{const r={...t};return r.startDate&&(r.startDate=r.startDate+"T00:00:00"),r.endDate&&(r.endDate=r.endDate+"T23:59:59"),r})(),u=await F(n);v(u.items||[]),D(u.total||0)}catch{}finally{g(!1)}};c.useEffect(()=>{A()},[t.limit,t.offset]);const M=n=>{a({...t,...n,offset:0})},y=c.useMemo(()=>{const n=Math.max(1,t.limit||20);return Math.ceil((l||0)/n)},[l,t.limit]),d=c.useMemo(()=>{const n=Math.max(1,t.limit||20);return Math.floor((t.offset||0)/n)+1},[t.offset,t.limit]),b=n=>{const u=Math.max(1,t.limit||20);a({...t,offset:(Math.max(1,n)-1)*u})},O=()=>{const n={created_at:"Fecha/Hora",user_id:"Usuario",event:"Evento",ref_type:"Ref Tipo",ref_id:"Ref ID",data:"Data"},u=o.map(i=>({...i,data:(()=>{try{const p=i.data?JSON.parse(i.data):null;return p?JSON.stringify(p):""}catch{return String(i.data||"")}})()})),r=Object.keys(n),R=r.map(i=>n[i]).join(","),T=u.map(i=>r.map(p=>{const S=i[p];if(S==null)return"";const f=String(S),w=f.includes(",")||f.includes(`
`)||f.includes('"'),C=f.replace(/"/g,'""');return w?`"${C}"`:C}).join(",")).join(`
`),_=R+`
`+T,j=new Blob([_],{type:"text/csv;charset=utf-8;"}),N=URL.createObjectURL(j),E=document.createElement("a");E.href=N,E.download="audits.csv",document.body.appendChild(E),E.click(),document.body.removeChild(E),URL.revokeObjectURL(N)};return e.createElement("div",{className:"container"},e.createElement(B,{items:["Admin","Auditoría"]}),e.createElement("h2",null,"Auditoría"),e.createElement(J,{filters:t,onChange:M,events:s}),e.createElement("div",{className:"row",style:{justifyContent:"space-between",marginBottom:8}},e.createElement("div",{className:"muted"},"Total: ",l," • Página ",d," de ",y),e.createElement("div",{className:"row",style:{gap:8}},e.createElement("select",{value:t.limit,onChange:n=>a({...t,limit:parseInt(n.target.value,10),offset:0}),title:"Tamaño de página"},e.createElement("option",{value:10},"10"),e.createElement("option",{value:20},"20"),e.createElement("option",{value:50},"50"),e.createElement("option",{value:100},"100")),e.createElement("button",{className:"btn",onClick:()=>b(Math.max(1,d-1)),disabled:d<=1},"Anterior"),e.createElement("button",{className:"btn",onClick:()=>b(d+1),disabled:d>=y},"Siguiente"),e.createElement("button",{className:"btn",onClick:O},"Exportar CSV"))),k?e.createElement(I,{lines:6}):e.createElement(L,{items:o,onShow:h}),e.createElement(H,{item:x,onClose:()=>h(null)}))}export{V as default};
